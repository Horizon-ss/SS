<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ุชูุฑูุฑ ุฑูุน ูููุน - v10</title>

  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <style>
    :root{
      --page:#0b3d2e;        /* ุฃุฎุถุฑ ุบุงูู */
      --card:#eef2f6;        /* ุฑุตุงุตู ูุงุชุญ ููุจุทุงูุงุช ูุงูุญููู */
      --ink:#0f172a;
      --muted:#64748b;
      --line:#cbd5e1;
    }
    html,body{background:var(--page);color:var(--ink);font-family:Verdana,'Cairo',system-ui,-apple-system,'Segoe UI',Tahoma,sans-serif}
    .card{border-radius:14px;background:var(--card);box-shadow:0 2px 10px rgba(0,0,0,.15);border:0}
    .card-header{background:var(--card);font-weight:700;border-bottom:1px solid rgba(0,0,0,.04)}
    .form-label{font-weight:600;font-size:.92rem}
    .form-control{padding:.4rem .6rem;font-size:.92rem;background:#fff;border-color:#dfe6ee}
    .form-control:focus{box-shadow:0 0 0 .15rem rgba(16,185,129,.25)}
    .table> :not(caption)>*>*{padding:.5rem .6rem}
    .table.table-sm> :not(caption)>*>*{padding:.35rem .5rem}
    .hint{color:var(--muted)}
    .hidden{display:none!important}
    .required:after{content:" *";color:#d72d2d;margin-right:4px}
    #statusBar,#statusBar2{font-size:.95rem;color:#e2e8f0}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .btn-primary{background:#0ea5a5;border-color:#0ea5a5}
    .btn-outline-primary{color:#0ea5a5;border-color:#0ea5a5}
    .btn-outline-primary:hover{background:#0ea5a5;color:#fff}
  </style>
</head>
<body>

<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3 text-white">
    <h1 class="h5 m-0" style="font-family:Verdana,'Cairo',sans-serif">ุชูุฑูุฑ ุฑูุน ูููุน</h1>
    <span class="badge bg-light text-dark border">v10</span>
  </div>

  <!-- ูุนูููุงุช ุนุงูุฉ -->
  <div class="card mb-3">
    <div class="card-header">ูุนูููุงุช ุงูุฒุจูู ูุงููููุน</div>
    <div class="card-body row g-3">
      <div class="col-md-4">
        <label class="form-label required">ุงุณู ุงูููุณุชูุฑ</label>
        <input id="customerName" type="text" class="form-control" placeholder="ูุซุงู: ุดุฑูุฉ ุณ">
      </div>
      <div class="col-md-4">
        <label class="form-label">ุฑูู ุงููุงุชู</label>
        <input id="phone" type="tel" class="form-control" placeholder="07xx xxx xxxx">
      </div>
      <div class="col-md-4">
        <label class="form-label required">ุงูุจุงูุฏ</label>
        <input id="bandField" type="text" class="form-control" placeholder="5GHz / 60GHz / Fiber">
      </div>

      <div class="col-md-9">
        <label class="form-label required">ุงููููุน</label>
        <div class="d-flex gap-2">
          <input id="location" type="text" class="form-control" placeholder="ุงูุนููุงู ุฃู ุงูุฅุญุฏุงุซูุงุช">
          <button id="pickLoc" type="button" class="btn btn-outline-primary btn-sm">๐ ุงูุชูุงุท ุชููุงุฆู</button>
        </div>
        <div class="hint mt-1">ุฒุฑ โุงูุชูุงุท ุชููุงุฆูโ ูููุฃ ุงูุฅุญุฏุงุซูุงุช ููุฑูุง (ูุญุชุงุฌ ุณูุงุญ ุงููุชุตูุญ).</div>
      </div>
      <div class="col-md-3">
        <label class="form-label">ุงูุชุงุฑูุฎ</label>
        <input id="reportDate" type="date" class="form-control">
      </div>

      <div class="col-md-3">
        <label class="form-label required">ุงุณู ุงูููู</label>
        <input id="techName" type="text" class="form-control" placeholder="ุงุณู ุงูููู">
      </div>
      <div class="col-md-3">
        <label class="form-label required">ุงููุชุงุจุนุฉ ูุน</label>
        <input id="engName" type="text" class="form-control" placeholder="ุงุณู ุงููุณุคูู">
      </div>
      <div class="col-md-3">
        <label class="form-label">POP/ุจูุจ</label>
        <input id="popField" type="text" class="form-control" placeholder="ูุซุงู: POP-123">
      </div>
      <div class="col-md-3">
        <label class="form-label">ุงูุนุจูุงุฑ</label>
        <input id="abarField" type="text" class="form-control" placeholder="A/B/C">
      </div>
      <div class="col-12">
        <div id="statusBar" class="small"></div>
      </div>
    </div>
  </div>

  <!-- ุงูุตูุฑ -->
  <div class="card mb-3">
    <div class="card-header">ุงูุตูุฑ ุงููุทููุจุฉ</div>
    <div class="card-body row g-3">
      <div class="col-md-6">
        <label class="form-label required">ุตูุฑุฉ ุจุงุชุฌุงู ุงูุจูุจ</label>
        <input id="img_pop" type="file" accept="image/*" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="form-label required">ุตูุฑุฉ ููุงู ุงูุชูุฑ/ุงูุจูู</label>
        <input id="img_tower" type="file" accept="image/*" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="form-label required">ุตูุฑุฉ ููุงู ูุตุจ ุงูุฑุงู/ุงูุฑุงูุชุฑ</label>
        <input id="img_rack" type="file" accept="image/*" class="form-control">
      </div>
      <div class="col-md-6">
        <label class="form-label required">ุตูุฑ ุฃูุงูู ุชุณููู ุงูููุจูุงุช</label>
        <input id="img_cables" type="file" accept="image/*" multiple class="form-control">
      </div>
      <div class="col-md-6">
        <label class="form-label">ุตูุฑ ุฃุฎุฑู (ุงุฎุชูุงุฑู)</label>
        <input id="img_other" type="file" accept="image/*" multiple class="form-control">
      </div>
    </div>
  </div>

  <!-- ุงูููุงุฏ ุงููุทููุจุฉ -->
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>ุงูููุงุฏ ุงููุทููุจุฉ</span>
      <button id="addCustomRow" class="btn btn-success btn-sm">โ ุฅุถุงูุฉ ูุงุฏุฉ</button>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>ุงูุฌูุงุฒ</th>
              <th>ุงูุชูุงุตูู</th>
              <th style="width:12%">ุงูุนุฏุฏ</th>
              <th>ููุงุญุธุงุช</th>
              <th style="width:8%"></th>
            </tr>
          </thead>
          <tbody id="extrasBody">
            <tr data-extra="dish">
              <td>ุงูุฏุด (Dish)</td>
              <td><input type="text" class="form-control extra-det" placeholder="ููุงุตูุงุช/ุญุฌู ุงูุฏุด"></td>
              <td><input type="number" min="0" class="form-control extra-qty" placeholder="0"></td>
              <td><input type="text" class="form-control extra-note" placeholder="ููุงุญุธุงุช"></td>
              <td></td>
            </tr>
            <tr data-extra="linkRouter">
              <td>ุฑุงูุชุฑ ุงูููู</td>
              <td><input type="text" class="form-control extra-det" placeholder="ุงุณู/ููุฏูู ุฑุงูุชุฑ ุงูููู"></td>
              <td><input type="number" min="0" class="form-control extra-qty" placeholder="0"></td>
              <td><input type="text" class="form-control extra-note" placeholder="ููุงุญุธุงุช"></td>
              <td></td>
            </tr>
            <tr data-extra="routerType">
              <td>ููุน ุงูุฑุงูุชุฑ</td>
              <td><input type="text" class="form-control extra-det" placeholder="ุงุณู/ููุฏูู ุงูุฑุงูุชุฑ"></td>
              <td><input type="number" min="0" class="form-control extra-qty" placeholder="0"></td>
              <td><input type="text" class="form-control extra-note" placeholder="ููุงุญุธุงุช"></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- ุงูููุงุฏ (ูุฏูุฌุฉ) -->
  <div class="card mb-3">
    <div class="card-header sr-only">ุงูููุงุฏ</div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th style="width:28%">ุงููุงุฏุฉ</th>
              <th style="width:14%">ุชูุนูู</th>
              <th style="width:12%">ุงูุนุฏุฏ</th>
              <th>ุฎูุงุฑุงุช ุฎุงุตุฉ</th>
              <th style="width:10%">ุญุฐู</th>
            </tr>
          </thead>
          <tbody id="materialsBody">
            <tr data-key="tower">
              <td>ุชูุฑ</td>
              <td><input type="checkbox" class="form-check-input"></td>
              <td><input type="number" min="0" class="form-control hidden" placeholder="0"></td>
              <td>
                <div class="form-check form-check-inline hidden">
                  <input class="form-check-input" type="radio" name="tower_pos" id="tower_ground">
                  <label class="form-check-label" for="tower_ground">ูู ุงูุฃุฑุถ</label>
                </div>
                <div class="form-check form-check-inline hidden">
                  <input class="form-check-input" type="radio" name="tower_pos" id="tower_roof">
                  <label class="form-check-label" for="tower_roof">ูู ุงูุณุทุญ</label>
                </div>
              </td>
              <td></td>
            </tr>
            <tr data-key="pole">
              <td>ุจูู</td>
              <td><input type="checkbox" class="form-check-input"></td>
              <td><input type="number" min="0" class="form-control hidden" placeholder="0"></td>
              <td>
                <div class="form-check form-check-inline hidden">
                  <input class="form-check-input" type="radio" name="pole_fix_type" id="pole_weld">
                  <label class="form-check-label" for="pole_weld">ูุญูู</label>
                </div>
                <div class="form-check form-check-inline hidden">
                  <input class="form-check-input" type="radio" name="pole_fix_type" id="pole_fix">
                  <label class="form-check-label" for="pole_fix">ุชุซุจูุช</label>
                </div>
              </td>
              <td></td>
            </tr>
            <tr data-key="rack">
              <td>ุฑุงู</td>
              <td><input type="checkbox" class="form-check-input"></td>
              <td><input type="number" min="0" class="form-control hidden" placeholder="0"></td>
              <td>
                <input id="size_rack" type="text" class="form-control hidden" placeholder="ุญุฌู ุงูุฑุงู (U)">
              </td>
              <td></td>
            </tr>
            <tr data-key="cable">
              <td>ููุจู</td>
              <td><input type="checkbox" class="form-check-input"></td>
              <td><input type="number" min="0" class="form-control hidden" placeholder="0"></td>
              <td><input type="text" class="form-control hidden" placeholder="ููุงุญุธุงุช/ุทูู/ููุน"></td>
              <td></td>
            </tr>
            <tr data-key="sfp">
              <td>SFP</td>
              <td><input type="checkbox" class="form-check-input"></td>
              <td><input type="number" min="0" class="form-control hidden" placeholder="0"></td>
              <td><input type="text" class="form-control hidden" placeholder="ููุฏูู/ููุงุญุธุงุช"></td>
              <td></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card mb-5">
    <div class="card-header">ููุงุญุธุงุช</div>
    <div class="card-body">
      <textarea id="finalNotes" class="form-control" rows="3" placeholder="ููุงุญุธุงุช ุนุงูุฉ..."></textarea>
    </div>
  </div>

  <div class="d-flex gap-2 mb-2">
    <button id="exportBtn" class="btn btn-primary btn-sm">๐พ ุชุตุฏูุฑ PDF</button>
    <button id="shareBtn" class="btn btn-outline-primary btn-sm">๐ ูุดุงุฑูุฉ</button>
    <div id="statusBar2" class="align-self-center ms-2 text-white"></div>
  </div>

</div>

<script>
(function(){
  const $=(s,c=document)=>c.querySelector(s);
  const $$=(s,c=document)=>Array.from(c.querySelectorAll(s));

  // Auto date
  const d = $('#reportDate');
  if(d && !d.value){ const now=new Date(); d.value=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`; }

  // GPS button
  $('#pickLoc')?.addEventListener('click', async()=>{
    const loc=$('#location'); const btn=$('#pickLoc');
    if(!('geolocation' in navigator)) return alert('ุงููุชุตูุญ ูุง ูุฏุนู ุชุญุฏูุฏ ุงููููุน');
    btn.disabled=true; const prev=btn.textContent; btn.textContent='ุฌุงุฑู ุงูุงูุชูุงุท...';
    try{
      await new Promise((resolve,reject)=>{
        navigator.geolocation.getCurrentPosition((pos)=>{
          const lat=pos.coords.latitude.toFixed(6), lon=pos.coords.longitude.toFixed(6);
          loc.value = `${lat}, ${lon}`; resolve();
        }, reject, {enableHighAccuracy:true, timeout:15000, maximumAge:0});
      });
      btn.textContent='ุชู โ';
    }catch(e){ alert('ุชุนุฐุฑ ุชุญุฏูุฏ ุงููููุน: '+e.message); btn.textContent=prev; }
    finally{ btn.disabled=false; }
  });

  // Materials toggles
  function bindToggleRow(tr){
    const key=tr.getAttribute('data-key');
    const chk=tr.querySelector('td:nth-child(2) input[type="checkbox"]');
    const qty=tr.querySelector('td:nth-child(3) input[type="number"]');
    const optsCell=tr.querySelector('td:nth-child(4)');
    function show(el,on){ if(!el) return; el.classList.toggle('hidden', !on); }
    function update(){
      const on=!!(chk&&chk.checked);
      show(qty,on);
      if(optsCell) optsCell.querySelectorAll('input, label, select, .form-check').forEach(el=>show(el,on));
      if(key==='rack') show(tr.querySelector('#size_rack'), on);
    }
    if(chk) chk.addEventListener('change', update);
    update();
  }
  $$('#materialsBody tr[data-key]').forEach(bindToggleRow);

  // Add/Delete custom material rows (in extras table)
  $('#addCustomRow')?.addEventListener('click', ()=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="text" class="form-control" placeholder="ุงุณู ุงููุงุฏุฉ/ุงูุฌูุงุฒ"></td>
      <td><input type="text" class="form-control extra-det" placeholder="ุงูุชูุงุตูู"></td>
      <td><input type="number" min="0" class="form-control extra-qty" placeholder="0"></td>
      <td><input type="text" class="form-control extra-note" placeholder="ููุงุญุธุงุช"></td>
      <td><button type="button" class="btn btn-sm btn-outline-danger del-row">ุญุฐู</button></td>`;
    $('#extrasBody').appendChild(tr);
  });
  $('#extrasBody')?.addEventListener('click', (e)=>{
    if(e.target.classList.contains('del-row')){
      e.target.closest('tr')?.remove();
    }
  });

  // Validation (required conditions before export)
  function validate(){
    const errors=[];
    const need=(sel,label)=>{ const el=$(sel); const v=(el?.value||'').trim(); if(!v) errors.push('โข '+label); };
    need('#customerName','ุงุณู ุงูููุณุชูุฑ');
    need('#location','ุงููููุน');
    need('#bandField','ุงูุจุงูุฏ');
    need('#techName','ุงุณู ุงูููู');
    need('#engName','ุงููุชุงุจุนุฉ ูุน');

    const needF=(sel,label)=>{ const el=$(sel); if(!el || !el.files || el.files.length===0) errors.push('โข '+label); };
    needF('#img_pop','ุตูุฑุฉ ุจุงุชุฌุงู ุงูุจูุจ');
    needF('#img_tower','ุตูุฑุฉ ููุงู ุงูุชูุฑ/ุงูุจูู');
    needF('#img_rack','ุตูุฑุฉ ููุงู ูุตุจ ุงูุฑุงู/ุงูุฑุงูุชุฑ');
    needF('#img_cables','ุตูุฑ ุฃูุงูู ุชุณููู ุงูููุจูุงุช');

    const tower=$('#materialsBody tr[data-key="tower"] input[type="checkbox"]');
    if(tower && tower.checked){
      const g=$('#tower_ground')?.checked, r=$('#tower_roof')?.checked;
      if(!g && !r) errors.push('โข ุงุฎุชุฑ ุทุฑููุฉ ูุตุจ ุงูุชูุฑ (ูู ุงูุฃุฑุถ/ูู ุงูุณุทุญ)');
    }
    const pole=$('#materialsBody tr[data-key="pole"] input[type="checkbox"]');
    if(pole && pole.checked){
      const w=$('#pole_weld')?.checked, f=$('#pole_fix')?.checked;
      if(!w && !f) errors.push('โข ุงุฎุชุฑ ููุน ุชุซุจูุช ุงูุจูู (ูุญูู/ุชุซุจูุช)');
    }

    if(errors.length){
      alert('ูุฑุฌู ุฅููุงู ุงูุญููู ูุจู ุงูุชุตุฏูุฑ:\n' + errors.join('\n'));
      return false;
    }
    return true;
  }

  // Collectors
  function collectMaterials(){
    const res=[];
    $$('#materialsBody tr').forEach(tr=>{
      const key=tr.getAttribute('data-key');
      let name=tr.cells[0]?.innerText?.trim();
      if(!name || name==='') name = tr.querySelector('td:first-child input')?.value?.trim();
      if(!name) return;
      const qtyVal = tr.querySelector('td:nth-child(3) input[type="number"]')?.value?.trim();
      const chk = tr.querySelector('td:nth-child(2) input[type="checkbox"]');
      const enabled = chk ? chk.checked : (!!qtyVal);
      if(!(enabled || qtyVal)) return;
      let details='';
      if(qtyVal) details += `ุงูุนุฏุฏ: ${qtyVal}`;
      if(key==='tower'){
        const g=$('#tower_ground')?.checked, r=$('#tower_roof')?.checked;
        if(g) details += (details?' | ':'')+'ูุตุจ ูู ุงูุฃุฑุถ';
        if(r) details += (details?' | ':'')+'ูุตุจ ูู ุงูุณุทุญ';
      }
      if(key==='pole'){
        const w=$('#pole_weld')?.checked, f=$('#pole_fix')?.checked;
        if(w) details += (details?' | ':'')+'ูุญูู';
        if(f) details += (details?' | ':'')+'ุชุซุจูุช';
      }
      if(key==='rack'){
        const size=$('#size_rack')?.value?.trim();
        if(size) details += (details?' | ':'')+`ุญุฌู ุงูุฑุงู: ${size}`;
        // ูุง ูุถูู "ููุงุญุธุงุช" ููุฑุงู
      } else {
        const noteVal= tr.querySelector('td:nth-child(4) input[type="text"]')?.value?.trim();
        if(noteVal) details += (details?' | ':'')+`ููุงุญุธุงุช: ${noteVal}`;
      }
      if(!details) details='ุจุฏูู ุชูุงุตูู';
      res.push({name, details});
    });
    return res;
  }

  function collectExtrasLines(){
    const lines=[];
    $$('#extrasBody tr').forEach(tr=>{
      const nameInput = tr.cells[0].querySelector('input');
      const name = nameInput ? nameInput.value.trim() : tr.cells[0].innerText.trim();
      const det =tr.querySelector('.extra-det')?.value?.trim();
      const qty =tr.querySelector('.extra-qty')?.value?.trim();
      const note=tr.querySelector('.extra-note')?.value?.trim();
      if(!(qty||det||note||name)) return;
      const parts=[];
      if(det) parts.push(det);
      if(qty) parts.push('ุงูุนุฏุฏ: '+qty);
      if(note) parts.push('ููุงุญุธุงุช: '+note);
      lines.push(`${name||'ูุงุฏุฉ'}: ${parts.join(' | ')}`);
    });
    return lines;
  }

  // Canvas helpers
  function drawParagraph(ctx, text, x, y, maxW, lh){
    const words = text.split(/(\s+)/).filter(Boolean);
    let line='';
    for(const w of words){
      const test = line + w;
      const width = ctx.measureText(test).width;
      if(width > maxW && line){
        ctx.fillText(line, x, y);
        y += lh;
        line = w.trimStart();
      }else{
        line = test;
      }
    }
    if(line){ ctx.fillText(line, x, y); y += lh; }
    return y;
  }

  async function buildFirstPageCanvas(){
    const c = document.createElement('canvas');
    const W = 2480, H = 3508; // A4 300dpi
    c.width=W; c.height=H;
    const ctx=c.getContext('2d');
    ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,W,H);

    await document.fonts.ready;
    ctx.direction='rtl';
    ctx.textAlign='right';
    const pad=160;
    let x=W-pad, y=pad;

    // Title (no "Horizon")
    ctx.fillStyle='#0f172a';
    ctx.font='700 78px Verdana, Cairo';
    ctx.fillText('Site Survey', x, y);
    y += 84;

    // KVs
    const kv=[];
    const v=(sel)=> (document.querySelector(sel)?.value||'').trim();
    const pop=v('#popField'), abar=v('#abarField');
    kv.push(['ุงูุฒุจูู', v('#customerName')]);
    kv.push(['ุงูุจุงูุฏ', v('#bandField')]);
    kv.push(['ูุงุชู', v('#phone')]);
    kv.push(['ุงููููุน', v('#location')]);
    if(pop || abar) kv.push(['ุงูุจูุจ/ุงูุนุจูุงุฑ', `${pop||''}${abar? ' | '+abar:''}`]);
    kv.push(['ุงูููู', v('#techName')]);
    kv.push(['ุงููุชุงุจุนุฉ ูุน', v('#engName')]);
    kv.push(['ุงูุชุงุฑูุฎ', v('#reportDate')]);

    const maxW=W-pad*2;
    const lineH=60;

    for(const [label,val] of kv){
      if(!val) continue;
      ctx.font='600 44px Verdana, Cairo';
      const lab=label+': ';
      const labW=ctx.measureText(lab).width;
      ctx.fillText(lab, x, y);
      ctx.font='400 44px Verdana, Cairo';
      y = drawParagraph(ctx, val, x - labW, y, maxW - labW, lineH);
    }

    // Separator
    y += 14;
    ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke();
    y += 56; // bigger gap before heading

    // Heading + underline + extra spacing
    ctx.font='700 50px Verdana, Cairo';
    ctx.fillText('ุงูููุงุฏ ุงููุทููุจุฉ', x, y);
    y += 18;
    ctx.strokeStyle='#cbd5e1'; ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke();
    y += 34; // larger space under heading

    // extras lines then materials
    const extraLines = collectExtrasLines();
    ctx.font='400 44px Verdana, Cairo';
    const mats = collectMaterials();
    function pushLine(t){ y = drawParagraph(ctx, t, x, y, maxW, lineH); }
    if(extraLines.length===0 && mats.length===0){
      pushLine('ูุง ุชูุฌุฏ ููุงุฏ.');
    }else{
      for(const line of extraLines){ pushLine(line); }
      for(const it of mats){
        pushLine('โข '+it.name+(it.details? ' โ '+it.details:''));
      }
    }

    // Notes
    const notes=(document.querySelector('#finalNotes')?.value||'').trim();
    if(notes){
      y += 22;
      pushLine('ุงูููุงุญุธุงุช: ' + notes);
    }

    return c.toDataURL('image/jpeg', 0.98);
  }

  async function imageDataUrlsFromInputs(){
    const list=[];
    async function push(input,label){
      const files=Array.from((input?.files)||[]);
      for(const f of files){
        const du = await new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(f); });
        list.push({label, name:f.name, dataUrl:du});
      }
    }
    await push($('#img_pop'),'ุตูุฑุฉ ุจุงุชุฌุงู ุงูุจูุจ');
    await push($('#img_tower'),'ุตูุฑุฉ ููุงู ุงูุชูุฑ/ุงูุจูู');
    await push($('#img_rack'),'ุตูุฑุฉ ููุงู ูุตุจ ุงูุฑุงู/ุงูุฑุงูุชุฑ');
    await push($('#img_cables'),'ุตูุฑ ุฃูุงูู ุชุณููู ุงูููุจูุงุช');
    await push($('#img_other'),'ุตูุฑ ุฃุฎุฑู');
    return list;
  }

  function captionAsImage(text, widthMM, heightMM){
    const dpi = 300;
    const mmToPx = mm => Math.round(mm * dpi / 25.4);
    const W = mmToPx(widthMM), H = mmToPx(heightMM);
    const c = document.createElement('canvas');
    c.width = W; c.height = H;
    const ctx = c.getContext('2d');
    ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,W,H);
    ctx.direction = 'rtl'; ctx.textAlign='center';
    ctx.fillStyle = '#111827';
    ctx.font = '400 28px Verdana, Cairo';
    ctx.fillText(text, W/2, Math.round(H*0.65));
    return c.toDataURL('image/png');
  }

  function addImagePage(doc, dataUrl, caption){
    return new Promise((resolve)=>{
      const img=new Image();
      img.onload=()=>{
        const pageW=doc.internal.pageSize.getWidth();
        const pageH=doc.internal.pageSize.getHeight();
        const iw=img.naturalWidth, ih=img.naturalHeight;
        const r=Math.min((pageW-20)/iw, (pageH-30-10)/ih);
        const w=iw*r, h=ih*r;
        doc.addPage();
        doc.addImage(dataUrl,'JPEG',(pageW-w)/2,10,w,h,undefined,'FAST');
        if(caption){
          const capDU = captionAsImage(caption, pageW-20, 12);
          doc.addImage(capDU,'PNG',10,pageH-16,pageW-20,12,undefined,'FAST');
        }
        resolve();
      };
      img.onerror=()=>{ doc.addPage(); resolve(); };
      img.src=dataUrl;
    });
  }

  async function buildPdfBlob(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({unit:'mm', format:'a4', compress:true});

    $('#statusBar').textContent='ุฌุงุฑู ุชุฌููุฒ ุงูุตูุญุฉ 1 ...';
    const page1 = await buildFirstPageCanvas();

    const pimg = new Image();
    await new Promise(res=>{ pimg.onload=res; pimg.src=page1; });
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const r = Math.min((pageW-20)/pimg.naturalWidth, (pageH-20)/pimg.naturalHeight);
    const w = pimg.naturalWidth*r, h = pimg.naturalHeight*r;
    doc.addImage(page1, 'JPEG', (pageW-w)/2, (pageH-h)/2, w, h, undefined, 'FAST');

    // Photos LAST
    $('#statusBar2').textContent='ุฌุงุฑู ุฅุถุงูุฉ ุงูุตูุฑ ...';
    const photos = await imageDataUrlsFromInputs();
    for(let i=0;i<photos.length;i++){
      const cap = `${photos[i].label}${photos.length>1? ' - '+(i+1):''}`;
      await addImagePage(doc, photos[i].dataUrl, cap);
      $('#statusBar2').textContent = `ุฅุถุงูุฉ ุงูุตูุฑ (${i+1}/${photos.length}) ...`;
    }

    const blob = doc.output('blob');
    const name = ($('#customerName')?.value || 'Site_Survey').replace(/[\\/:*?"<>|]/g,'_') + '.pdf';
    return {blob, name};
  }

  async function exportPDF(){
    if(!validate()) return;
    const {blob, name} = await buildPdfBlob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = name; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
    $('#statusBar2').textContent='ุชู ุงูุญูุธ โ';
  }

  async function sharePDF(){
    if(!validate()) return;
    try{
      const {blob, name} = await buildPdfBlob();
      if(navigator.canShare && navigator.canShare({ files: [new File([blob], name, {type:'application/pdf'})] })){
        await navigator.share({ files: [ new File([blob], name, {type:'application/pdf'}) ], title: name, text: 'ุชูุฑูุฑ ูููุน' });
      }else{
        // fallback: open blob (user can share ูู ุงููุชุตูุญ)
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
      }
    }catch(e){
      alert('ุชุนุฐุฑ ุงููุดุงุฑูุฉ: ' + e.message);
    }
  }

  $('#exportBtn')?.addEventListener('click', exportPDF);
  $('#shareBtn')?.addEventListener('click', sharePDF);
})();</script>

</body>
</html>
